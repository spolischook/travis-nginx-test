parameters:
    orob2b_checkout.entity.base_checkout.class: OroB2B\Bundle\CheckoutBundle\Entity\BaseCheckout
    orob2b_checkout.entity.checkout.class: OroB2B\Bundle\CheckoutBundle\Entity\Checkout
    orob2b_checkout.entity.checkout_source.class: OroB2B\Bundle\CheckoutBundle\Entity\CheckoutSource

services:
    # Data Providers
    orob2b_checkout.layout.data_provider.abstract_transition:
        class: 'OroB2B\Bundle\CheckoutBundle\Layout\DataProvider\AbstractTransitionDataProvider'
        arguments:
            - '@oro_workflow.manager'

    orob2b_checkout.data_provider.converter.checkout_line_items:
        class: 'OroB2B\Bundle\CheckoutBundle\DataProvider\Converter\CheckoutLineItemsConverter'
        public: false
        arguments:
            - '@property_accessor'

    orob2b_checkout.data_provider.manager.checkout_line_items:
        class: 'OroB2B\Bundle\CheckoutBundle\DataProvider\Manager\CheckoutLineItemsManager'
        public: false
        arguments:
            - '@orob2b_checkout.data_provider.converter.checkout_line_items'
            - '@orob2b_pricing.user_currency_manager'
            - '@oro_config.manager'

    orob2b_checkout.layout.data_provider.summary:
        class: 'OroB2B\Bundle\CheckoutBundle\Layout\DataProvider\SummaryDataProvider'
        arguments:
            - '@orob2b_checkout.data_provider.manager.checkout_line_items'
            - '@orob2b_pricing.subtotal_processor.provider.subtotal_line_item'
            - '@orob2b_pricing.subtotal_processor.total_processor_provider'
        tags:
            - { name: layout.data_provider, alias: orob2b_checkout_summary }

    orob2b_checkout.layout.data_provider.transition_form:
        class: 'OroB2B\Bundle\CheckoutBundle\Layout\DataProvider\TransitionFormDataProvider'
        arguments:
            - '@form.factory'
        calls:
            - [setContinueTransitionDataProvider, ['@orob2b_checkout.layout.data_provider.continue_transition']]
        tags:
            - { name: layout.data_provider, alias: orob2b_checkout_transition_form }

    orob2b_checkout.layout.data_provider.continue_transition:
        class: 'OroB2B\Bundle\CheckoutBundle\Layout\DataProvider\ContinueTransitionDataProvider'
        parent: orob2b_checkout.layout.data_provider.abstract_transition
        tags:
            - { name: layout.data_provider, alias: orob2b_checkout_continue_transition }

    orob2b_checkout.layout.data_provider.checkout_steps:
        class: 'OroB2B\Bundle\CheckoutBundle\Layout\DataProvider\CheckoutStepsDataProvider'
        arguments:
            - '@oro_workflow.manager'
        tags:
            - { name: layout.data_provider, alias: orob2b_checkout_steps }

    orob2b_checkout.layout.data_provider.back_transitions:
        class: 'OroB2B\Bundle\CheckoutBundle\Layout\DataProvider\BackTransitionsDataProvider'
        parent: orob2b_checkout.layout.data_provider.abstract_transition
        tags:
            - { name: layout.data_provider, alias: orob2b_checkout_back_transitions }

    orob2b_checkout.layout.data_provider.back_transition:
        class: 'OroB2B\Bundle\CheckoutBundle\Layout\DataProvider\BackTransitionDataProvider'
        calls:
            - [setBackTransitionsDataProvider, ['@orob2b_checkout.layout.data_provider.back_transitions']]
        tags:
            - { name: layout.data_provider, alias: orob2b_checkout_back_transition }

    orob2b_checkout.model.action.get_order_line_items:
        class: 'OroB2B\Bundle\CheckoutBundle\Model\Action\GetOrderLineItems'
        arguments:
            - '@oro_action.context_accessor'
            - '@orob2b_checkout.data_provider.manager.checkout_line_items'
        tags:
            - { name: oro_workflow.action, alias: get_order_line_items }

    orob2b_checkout.model.action.start_checkout:
        class: 'OroB2B\Bundle\CheckoutBundle\Model\Action\StartCheckout'
        calls:
            - [setCheckoutClass, ['%orob2b_checkout.entity.checkout.class%']]
            - [setCheckoutRoute, ['orob2b_checkout_frontend_checkout']]
        arguments:
            - '@oro_action.context_accessor'
            - '@doctrine'
            - '@orob2b_website.manager'
            - '@orob2b_pricing.user_currency_manager'
            - '@security.token_storage'
            - '@property_accessor'
            - '@oro_action.action.redirect'
            - '@event_dispatcher'
        tags:
            - { name: oro_action.action, alias: start_checkout }

    orob2b_checkout.expression.acl_granted:
        class: OroB2B\Bundle\CheckoutBundle\Expression\CheckRequest
        arguments:
            - '@request_stack'
        tags:
            - { name: oro_workflow.condition, alias: check_request }

    orob2b_checkout.twig.line_items:
        class: 'OroB2B\Bundle\CheckoutBundle\Twig\LineItemsExtension'
        public: false
        arguments:
            - '@orob2b_pricing.subtotal_processor.total_processor_provider'
            - '@orob2b_pricing.subtotal_processor.provider.subtotal_line_item'
        tags:
            - { name: twig.extension }

    # Listener in checkout bundle should be handled first to allow custom listeners overwrite result
    orob2b_checkout.event_listener.checkout_entity.abstract:
        class: OroB2B\Bundle\CheckoutBundle\EventListener\CheckoutEntityListener
        lazy: true
        arguments:
            - '@oro_workflow.manager'
            - '@doctrine'
            - '@orob2b_pricing.user_currency_manager'

    orob2b_checkout.event_listener.checkout_entity:
        parent: 'orob2b_checkout.event_listener.checkout_entity.abstract'
        calls:
            - [setCheckoutClassName, ['%orob2b_checkout.entity.checkout.class%']]
        tags:
            - {name: kernel.event_listener, event: orob2b_checkout.get_checkout_entity, method: onGetCheckoutEntity}
            - {name: kernel.event_listener, event: orob2b_checkout.create_checkout_entity, method: onCreateCheckoutEntity}

    orob2b_checkout.grid_totals_metadata.cache:
        public: false
        parent: oro.cache.abstract
        calls:
            - [ setNamespace, [ 'orob2b_checkout_grid_totals_metadata' ] ]

    orob2b_checkout.repository.base_checkout:
        class: Doctrine\ORM\EntityRepository
        public: false
        factory:  ['@oro_entity.doctrine_helper', getEntityRepository]
        arguments:
            - '%orob2b_checkout.entity.base_checkout.class%'

    orob2b_checkout.datagrid.column_builder.items_count:
        class: OroB2B\Bundle\CheckoutBundle\Datagrid\ColumnBuilder\ItemsCountColumnBuilder
        arguments:
            - '@orob2b_checkout.repository.base_checkout'

    orob2b_checkout.datagrid.column_builder.started_from:
        class: OroB2B\Bundle\CheckoutBundle\Datagrid\ColumnBuilder\StartedFromColumnBuilder
        arguments:
            - '@orob2b_checkout.repository.base_checkout'
            - '@translator'
            - '@oro_security.security_facade'

    orob2b_checkout.datagrid.column_builder.total:
        class: OroB2B\Bundle\CheckoutBundle\Datagrid\ColumnBuilder\TotalColumnBuilder
        arguments:
            - '@doctrine'
            - '@orob2b_pricing.subtotal_processor.total_processor_provider'

    orob2b_checkout.datagrid.checkout_grid_listener:
        class: OroB2B\Bundle\CheckoutBundle\Datagrid\CheckoutGridListener
        arguments:
            - '@oro_entity_config.provider.entity'
            - '@oro_query_designer.entity_field_provider'
            - '@doctrine'
            - '@orob2b_pricing.user_currency_manager'
        calls:
            - [setCache, ['@orob2b_checkout.grid_totals_metadata.cache']]
            - [addColumnBuilder, ['@orob2b_checkout.datagrid.column_builder.items_count']]
            - [addColumnBuilder, ['@orob2b_checkout.datagrid.column_builder.started_from']]
            - [addColumnBuilder, ['@orob2b_checkout.datagrid.column_builder.total']]
        tags:
            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.before.frontend-checkouts-grid, method: onBuildBefore }
            - { name: kernel.event_listener, event: oro_datagrid.orm_datasource.result.after.frontend-checkouts-grid, method: onResultAfter }

    orob2b_checkout.datagrid.checkout_grid_column_filter:
        class: 'OroB2B\Bundle\CheckoutBundle\Datagrid\CheckoutGridColumnFilter'
        arguments:
            - '@orob2b_account.security.account_user_provider'
        tags:
            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.before.frontend-checkouts-grid, method: onBuildBefore }

    orob2b_checkout.workflow.condition.order_line_item_has_count:
        class: 'OroB2B\Bundle\CheckoutBundle\Model\Condition\OrderLineItemsHasCount'
        arguments:
            - '@orob2b_checkout.data_provider.manager.checkout_line_items'
        tags:
            - { name: oro_workflow.condition, alias: order_line_item_has_count }

method: getTax
reference: simple_order
configuration:
    use_as_base_by_default: destination
    destination: shipping_address
    start_calculation_on: total
    start_calculation_with: unit_price
    product_prices_include_tax: false
databaseBefore:
    'OroB2B\Bundle\OrderBundle\Entity\Order':
        simple_order:
            poNumber: { property_value: simple_order }
            account: { class: 'OroB2B\Bundle\AccountBundle\Entity\Account', query: { name: 'account.orphan' } }
            currency: 'USD'
            shippingAddress:
                class: 'OroB2B\Bundle\OrderBundle\Entity\OrderAddress'
                property_value:
                    country: { class: 'Oro\Bundle\AddressBundle\Entity\Country', query: { iso2Code: 'US' } }
                    region: { class: 'Oro\Bundle\AddressBundle\Entity\Region', query: { combinedCode: 'US-CA' } }
    'OroB2B\Bundle\ProductBundle\Entity\Product':
        product_1:
            sku: { property_value: product_1 }
        product_2:
            sku: { property_value: product_2 }
        product_3:
            sku: { property_value: product_3 }
        product_4:
            sku: { property_value: product_4 }
    'OroB2B\Bundle\OrderBundle\Entity\OrderLineItem':
        order_line_item_1:
            productSku: { property_value: order_line_item_1 }
            order: { reference: simple_order }
            quantity: { property_value: 41 }
            price: { class: 'Oro\Bundle\CurrencyBundle\Entity\Price', property_value: { value: '3.42', currency: USD } }
            product: { reference: product_1 }
        order_line_item_2:
            productSku: { property_value: order_line_item_2 }
            order: { reference: simple_order }
            quantity: { property_value: 15 }
            price: { class: 'Oro\Bundle\CurrencyBundle\Entity\Price', property_value: { value: '8.55', currency: USD } }
            product: { reference: product_2 }
        order_line_item_3:
            productSku: { property_value: order_line_item_3 }
            order: { reference: simple_order }
            quantity: { property_value: 13 }
            price: { class: 'Oro\Bundle\CurrencyBundle\Entity\Price', property_value: { value: '18.05', currency: USD } }
            product: { reference: product_3 }
        order_line_item_4:
            productSku: { property_value: order_line_item_4 }
            order: { reference: simple_order }
            quantity: { property_value: 35 }
            price: { class: 'Oro\Bundle\CurrencyBundle\Entity\Price', property_value: { value: '24.80', currency: USD } }
            product: { reference: product_4 }
    'OroB2B\Bundle\TaxBundle\Entity\ProductTaxCode':
        product_tax_code:
            code: product_tax_code
            products:
                property_value:
                    - { reference: product_1 }
                    - { reference: product_2 }
                    - { reference: product_3 }
                    - { reference: product_4 }
    'OroB2B\Bundle\TaxBundle\Entity\TaxRule':
        tax_rule_1:
            tax: { class: 'OroB2B\Bundle\TaxBundle\Entity\Tax', query: { code: 'TAX1' } }
            taxJurisdiction: { class: 'OroB2B\Bundle\TaxBundle\Entity\TaxJurisdiction', query: { code: 'TAX3' } }
            productTaxCode: { reference: product_tax_code }
            accountTaxCode: { class: 'OroB2B\Bundle\TaxBundle\Entity\AccountTaxCode', query: { code: 'TAX1' } }
        tax_rule_2:
            tax: { class: 'OroB2B\Bundle\TaxBundle\Entity\Tax', query: { code: 'TAX3' } }
            taxJurisdiction: { class: 'OroB2B\Bundle\TaxBundle\Entity\TaxJurisdiction', query: { code: 'TAX3' } }
            productTaxCode: { reference: product_tax_code }
            accountTaxCode: { class: 'OroB2B\Bundle\TaxBundle\Entity\AccountTaxCode', query: { code: 'TAX1' } }
expectedResult:
    total:
        includingTax: '1611.07' # 164.7585 + 150.69375 + 275.71375 + 1019.9 = 1611.066
        excludingTax: '1371.12' # 140.22 + 128.25 + 234.65 + 868
        taxAmount: '239.95'     # 24.5385 + 22.44375 + 41.06375 + 151.9 = 239.946
        adjustment: '0.006'     # 0.00375 + 0.00375 + -0.0015
        currency: 'USD'
    taxes:
        - { tax: 'TAX1', rate: '0.1', taxable_amount: '1371.12', tax_amount: '137.11', currency: 'USD' }       # 1371.12 * 0.1
        - { tax: 'TAX3', rate: '0.075', taxable_amount: '1371.12', tax_amount: '102.83', currency: 'USD' }     # 1371.12 * 0.075
    items:
        -
            row:
                includingTax: '164.76'  # 4.0185 * 41 = 164.7585
                excludingTax: '140.22'  # 3.42 * 41
                taxAmount: '24.54'      # 0.5985 * 41 = 24.5385
                adjustment: '-0.0015'   # 24.5385 - 24.54
                currency: 'USD'
            unit:
                includingTax: '4.02'    # 3.42 + 0.5985 = 4.0185
                excludingTax: '3.42'
                taxAmount: '0.6'        # 3.42 * 0.175 = 0.5985
                adjustment: '-0.0015'   # 0.5985 - 0.6
                currency: 'USD'
            taxes:
                - { tax: 'TAX1', rate: '0.1', taxable_amount: '140.22', tax_amount: '14.02', currency: 'USD' }   # 140.22 * 0.1
                - { tax: 'TAX3', rate: '0.075', taxable_amount: '140.22', tax_amount: '10.52', currency: 'USD' } # 140.22 * 0.075
        -
            row:
                includingTax: '150.69'  # 10.04625 * 15 = 150.69375
                excludingTax: '128.25'  # 8.55 * 15
                taxAmount: '22.44'      # 1.49625 * 15 = 22.44375
                adjustment: '0.00375'  # 22.44375 - 22.44
                currency: 'USD'
            unit:
                includingTax: '10.05'   # 8.55 + 1.49625 = 10.04625
                excludingTax: '8.55'
                taxAmount: '1.5'        # 8.55 * 0.175 = 1.49625
                adjustment: '-0.00375'  # 1.49625 - 1.5
                currency: 'USD'
            taxes:
                - { tax: 'TAX1', rate: '0.1', taxable_amount: '128.25', tax_amount: '12.83', currency: 'USD' }  # 128.25 * 0.1
                - { tax: 'TAX3', rate: '0.075', taxable_amount: '128.25', tax_amount: '9.62', currency: 'USD' } # 128.25 * 0.075
        -
            row:
                includingTax: '275.71'  # 21.20875 * 13 = 275.71375
                excludingTax: '234.65'  # 18.05 * 13
                taxAmount: '41.06'      # 3.15875 * 13 = 41.06375
                adjustment: '0.00375'   # 41.06375 - 41.06
                currency: 'USD'
            unit:
                includingTax: '21.21'   # 18.05 + 3.15875 = 21.20875
                excludingTax: '18.05'
                taxAmount: '3.16'       # 18.05 * 0.175 = 3.15875
                adjustment: '-0.00125'  # 3.15875 - 3.16
                currency: 'USD'
            taxes:
                - { tax: 'TAX1', rate: '0.1', taxable_amount: '234.65', tax_amount: '23.47', currency: 'USD' }  # 234.65 * 0.1
                - { tax: 'TAX3', rate: '0.075', taxable_amount: '234.65', tax_amount: '17.6', currency: 'USD' } # 234.65 * 0.075
        -
            row:
                includingTax: '1019.9'  # 29.14 * 35
                excludingTax: '868'     # 24.8 * 35
                taxAmount: '151.9'      # 4.34 * 35
                adjustment: '0'
                currency: 'USD'
            unit:
                includingTax: '29.14'   # 24.8 + 4.34
                excludingTax: '24.8'
                taxAmount: '4.34'       # 24.8 * 0.175
                adjustment: '0'
                currency: 'USD'
            taxes:
                - { tax: 'TAX1', rate: '0.1', taxable_amount: '868', tax_amount: '86.8', currency: 'USD' }      # 868 * 0.1
                - { tax: 'TAX3', rate: '0.075', taxable_amount: '868', tax_amount: '65.1', currency: 'USD' }    # 868 * 0.075

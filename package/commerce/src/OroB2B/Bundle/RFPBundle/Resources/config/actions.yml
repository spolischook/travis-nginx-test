actions:
    orob2b_rfp_change_status_action:
        label: orob2b.rfp.btn.change_status
        applications: [backend]
        routes:
            - orob2b_rfp_request_view
        datagrids:
            - rfp-requests-grid
        order: 10
        attributes:
            request_status:
                property_path: entity.status
            request_note:
                property_path: entity.note
                label: oro.note.entity_label
                type: string
        form_options:
            attribute_fields:
                request_status:
                    form_type: orob2b_rfp_request_status_select
                    options:
                        required: true
                request_note:
                    form_type: oro_rich_text
            attribute_default_values:
                request_status: $status
        button_options:
            icon: icon-edit
        frontend_options:
            template: OroB2BRFPBundle:Action:changeStatusForm.html.twig
            title: orob2b.rfp.widget.change_status_title
            options:
                width: 550
        functions:
            - @assign_value: [$status, $.request_status]
            - @format_string:
                attribute: $.message
                string: 'New status: %%status%% <p></p> %%note%%'
                arguments:
                    status: $.request_status.label
                    note: $.request_note
            - @create_entity:
                class: Oro\Bundle\NoteBundle\Entity\Note
                attribute: $.note
                data:
                    target: $.data
                    message: $.message
                flush: true
            - @flash_message:
                message: orob2b.rfp.message.request_status_changed
                type: 'info'

    orob2b_rfp_cancel_action:
        label: orob2b.rfp.request.cancel.label
        enabled: true
        applications: [backend]
        routes:
            - orob2b_rfp_request_view
        datagrids:
            - rfp-requests-grid
        order: 90
        attributes:
            cancellation_reason:
                property_path: entity.cancellationReason
                label: orob2b.rfp.request.cancellation_reason.label
                type: string
        form_options:
            attribute_fields:
                cancellation_reason:
                    form_type: oro_rich_text
        button_options:
            icon: icon-ban-circle
        frontend_options:
            template: OroB2BRFPBundle:Action:cancelForm.html.twig
            title: orob2b.rfp.widget.cancel_title
            options:
                width: 550
        prefunctions:
            - @assign_constant_value:
                attribute: $.cancelledStatusName
                value: OroB2B\Bundle\RFPBundle\Entity\RequestStatus::CANCELED
            - @assign_constant_value:
                attribute: $.deletedStatusName
                value: OroB2B\Bundle\RFPBundle\Entity\RequestStatus::DELETED
        preconditions:
            @and:
                - @not_empty: $status
                - @not_equal: [$status.name, $.cancelledStatusName]
                - @not_equal: [$status.name, $.deletedStatusName]
        functions:
            - @find_entity:
                class: OroB2B\Bundle\RFPBundle\Entity\RequestStatus
                attribute: $status
                where:
                    name: $.cancelledStatusName
            - @assign_value: [$cancellationReason, $.cancellation_reason]
            - @flash_message:
                message: 'orob2b.rfp.request.cancellation_success.label'
                type: 'info'

    orob2b_rfp_create_quote_action:
        label: orob2b.rfp.btn.create_quote
        applications: [backend]
        routes:
            - orob2b_rfp_request_view
        acl_resource: orob2b_sale_quote_create
        order: 20
        button_options:
            icon: icon-file-text
            class: icons-holder-text no-hash btn
        preconditions:
            @equal: [$status.draft, false]
        functions:
            - @call_service_method:
                service: orob2b_rfp.service.request_to_quote_data_storage
                method: saveToStorage
                method_parameters: [$.data]
            - @redirect:
                parameters:
                    route: orob2b_sale_quote_create
                    route_parameters: {'storage': true}

    orob2b_rfp_frontend_request_a_quote_action:
        label: orob2b.rfp.btn.add_to_rfp
        applications: [frontend]
        routes:
            - orob2b_product_frontend_quick_add
            - orob2b_product_frontend_quick_add_copy_paste
            - orob2b_product_frontend_quick_add_import
        acl_resource: [CREATE, entity:commerce@OroB2B\Bundle\RFPBundle\Entity\Request]
        order: 10
        button_options:
            icon: icon-file-text
            data:
                component_name: orob2b_rfp_quick_add_processor
            page_component_module: orob2bproduct/js/app/components/quick-add-form-button-component
            page_component_options:
                component_name: '[name$="[component]"]'
                component_additional: '[name$="[additional]"]'
        prefunctions:
            - @call_service_method:
                service: orob2b_rfp.processor.quick_add
                method: isAllowed
                attribute: $.isAllowed
        preconditions:
            @equal: [true, $.isAllowed]

    orob2b_rfp_base_edit_action:
        label: ' '
        applications: [backend]
        attributes:
            request:
                label: ' '
                type: entity
                options:
                    class: OroB2B\Bundle\RFPBundle\Entity\Request
        form_options:
            attribute_fields:
                request:
                    form_type: orob2b_rfp_request
            attribute_default_values:
                request:
                    $.data

    orob2b_rfp_edit_action:
        extends: orob2b_rfp_base_edit_action
        label: orob2b.rfp.btn.edit
        routes:
            - orob2b_rfp_request_view
        datagrids:
            - rfp-requests-grid
        order: 70
        button_options:
            icon: icon-edit
        acl_resource: orob2b_rfp_request_update
        frontend_options:
            template: OroB2BRFPBundle:Action:rfpEditForm.html.twig
            show_dialog: false
        functions:
            - @flash_message:
                message: orob2b.rfp.action.request.updated.message
                type: 'success'
            - @redirect:
                route: 'orob2b_rfp_request_view'
                route_parameters:
                    id: $id

    orob2b_rfp_resubmit_action:
        extends: orob2b_rfp_base_edit_action
        label: orob2b.rfp.btn.resubmit
        applications: [backend]
        routes:
            - orob2b_rfp_request_view
        datagrids:
            - rfp-requests-grid
        order: 80
        button_options:
            icon: icon-share
        acl_resource: orob2b_rfp_request_update
        frontend_options:
            template: OroB2BRFPBundle:Action:rfpResubmitForm.html.twig
            show_dialog: false
        form_init:
            - @assign_constant_value:
                attribute: $.openStatusName
                value: OroB2B\Bundle\RFPBundle\Entity\RequestStatus::OPEN
            - @create_datetime:
                attribute: $.currentDatetime
            - @duplicate:
                attribute: $.entityCopy
                settings:
                  - [[setNull], [propertyName, [id]]]
                  - [[collection], [propertyType, ['Doctrine\Common\Collections\Collection']]]
                  - [[setNull], [propertyName, [status]]]
                  - [[keep], [propertyName, [accountUser]]]
                  - [[keep], [propertyName, [account]]]
                  - [[keep], [propertyName, [organization]]]
                  - [[keep], [property, [%orob2b_rfp.entity.request_product.class%, product]]]
                  - [[keep], [property, [%orob2b_rfp.entity.request_product_item.class%, productUnit]]]
            - @assign_value: [$.entityCopy.createdAt, $.currentDatetime]
            - @assign_value: [$.entityCopy.updatedAt, $.currentDatetime]
            - @find_entity:
                class: OroB2B\Bundle\RFPBundle\Entity\RequestStatus
                attribute: $.entityCopy.status
                where:
                    name: $.openStatusName
            - @assign_value: [$.data, $.entityCopy]
        functions:
            - @flush_entity: ~
            - @flash_message:
                message: orob2b.rfp.action.request.resubmited.message
                type: 'success'
            - @redirect:
                route: 'orob2b_rfp_request_view'
                route_parameters:
                    id: $id

    orob2b_rfp_delete_action:
        label: orob2b.rfp.btn.delete
        enabled: true
        applications: [backend]
        routes:
            - orob2b_rfp_request_view
        datagrids:
            - rfp-requests-grid
        order: 100
        button_options:
            icon: icon-delete
        frontend_options:
            confirmation: orob2b.rfp.request.actions.delete_frp_confirm
        prefunctions:
            - @assign_constant_value:
                attribute: $.deletedStatusName
                value: OroB2B\Bundle\RFPBundle\Entity\RequestStatus::DELETED
        preconditions:
            @and:
                - @not_empty: $status
                - @not_equal: [$status.name, $.deletedStatusName]
        functions:
            - @find_entity:
                class: OroB2B\Bundle\RFPBundle\Entity\RequestStatus
                attribute: $status
                where:
                    name: $.deletedStatusName
            - @create_datetime:
                attribute: $deletedAt

    orob2b_rfp_frontend_request_create_action:
        label: orob2b.frontend.rfp.request.create.label
        enabled: true
        applications: [frontend]
        routes:
            - orob2b_rfp_frontend_request_index
        acl_resource: [CREATE, entity:commerce@OroB2B\Bundle\RFPBundle\Entity\Request]
        order: 10
        functions:
            - @redirect:
                parameters:
                    route: orob2b_rfp_frontend_request_create

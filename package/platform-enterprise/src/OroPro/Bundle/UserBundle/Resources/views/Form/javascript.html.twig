{% macro filterRoles(form) %}
    <script type="text/javascript">
        require(['jquery', 'underscore'], function ($, _) {
            "use strict";
            var roles = $('#{{ form.roles.vars.id }}').find('input[type="checkbox"]');
            var permissionsMap = $.parseJSON('{{ form.vars.permissions_map | raw }}');

            roles.each(function(key, elm) {
                var roleId = elm.value;
                var granted = permissionsMap[roleId]['org_id'] == null || isOrganizationForRoleChecked(roleId);

                var label = $('label[for="' + elm.id + '"]');
                label.html(permissionsMap[roleId]['label']);

                if (!granted) {
                    hideCheckboxElement(elm);
                }
            });

            $(function() {
                $('input[name="oro_user_user_form[businessUnits]"]').change(
                    function () {
                        roles.each(function (key, elm) {
                            var roleId = elm.value;
                            var granted = (permissionsMap[roleId]['org_id'] == null || isOrganizationForRoleChecked(roleId));
                            if (!granted) {
                                hideCheckboxElement(elm);
                            } else {
                                showCheckboxElement(elm)
                            }
                        });
                    }
                );

            });

            function hideCheckboxElement(elm) {
                $('label[for="' + elm.id + '"]').hide();
                $(elm).hide();
            }

            function showCheckboxElement(elm) {
                var roleId = elm.value;
                var label = $('label[for="' + elm.id + '"]');
                label.html(permissionsMap[roleId]['label']);
                label.show();
                $(elm).show();
            }

            function isOrganizationForRoleChecked(roleId) {
                var values = $('input[name="oro_user_user_form[businessUnits]"]').val();
                values = values.split(',');

                var checkedOrganization = values.filter(function (value) {
                    var selectedValue = getValueFromSelectedData(parseInt(value));
                    if (selectedValue) {
                        return parseInt(selectedValue.organization_id) == permissionsMap[roleId]['org_id'];
                    }
                });

                return checkedOrganization.length > 0;
            }

            function getValueFromSelectedData(val) {
                var selectedData = $('input[name="oro_user_user_form[businessUnits]"]').data().selectedData;

                return selectedData.filter(function(item) {
                    return item.id == val;
                }).pop();
            }
        });
    </script>
{% endmacro %}

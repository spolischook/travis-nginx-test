<?php
namespace OroCRMPro\Bundle\DemoDataBundle\Migrations\Data\B2C\ORM\Magento;

use Doctrine\Common\Persistence\ObjectManager;
use Doctrine\Common\DataFixtures\DependentFixtureInterface;

use OroCRM\Bundle\ContactBundle\Entity\Contact;
use OroCRM\Bundle\MagentoBundle\Entity\Address;
use OroCRM\Bundle\MagentoBundle\Entity\Customer;

use OroCRM\Bundle\ContactBundle\Entity\ContactAddress;

use OroCRMPro\Bundle\DemoDataBundle\Migrations\Data\B2C\ORM\AbstractFixture;

class LoadCustomerData extends AbstractFixture implements DependentFixtureInterface
{
    /**
     * {@inheritdoc}
     */
    public function getDependencies()
    {
        return [
            'OroCRMPro\Bundle\DemoDataBundle\Migrations\Data\B2C\ORM\LoadContactData',
            __NAMESPACE__ . '\\LoadWebsiteData',
            __NAMESPACE__ . '\\LoadStoreData',
            __NAMESPACE__ . '\\LoadCustomerGroupData',
            __NAMESPACE__ . '\\LoadMagentoIntegrationData',
        ];
    }

    /**
     * @return array
     */
    public function getData()
    {
        return [
            'customers' => $this->loadData('magento/customers.csv'),
        ];
    }

    /**
     * {@inheritDoc}
     */
    public function load(ObjectManager $manager)
    {
        $data = $this->getData();
        foreach ($data['customers'] as $customerData) {
            $website = $this->getWebsiteReference($customerData['website uid']);
            $store = $this->getStoreReference($customerData['store uid']);
            $customerGroup = $this->getCustomerGroupReference($customerData['customer group uid']);
            $integration = $this->getIntegrationReference($customerData['integration uid']);
            $contact = $this->getContactReference($customerData['contact uid']);
            $dataChannel = $this->getIntegrationDataChannelReference($customerData['integration uid']);

            $customer = new Customer();
            $customer->setWebsite($website)
                ->setChannel($integration)
                ->setStore($store)
                ->setFirstName($contact->getFirstName())
                ->setLastName($contact->getLastName())
                ->setEmail($contact->getPrimaryEmail())
                ->setBirthday($contact->getBirthday())
                ->setVat(mt_rand(10000000, 99999999))
                ->setGroup($customerGroup)
                ->setCreatedAt($this->generateUpdatedDate($contact->getCreatedAt()))
                ->setUpdatedAt($this->generateUpdatedDate($customer->getCreatedAt()))
                ->setAccount($contact->getAccounts()->first())
                ->setContact($contact)
                ->setOrganization($contact->getOrganization())
                ->setOwner($contact->getOwner());
            $customer->setDataChannel($dataChannel);
            $this->addCustomerAddress($customer, $contact);

            $this->setCustomerReference($customerData['uid'], $customer);
            $manager->persist($customer);
        }
        $manager->flush();
    }

    /**
     * @param Customer $customer
     * @param Contact $contact
     */
    protected function addCustomerAddress(Customer $customer, Contact $contact)
    {
        if($contact->getAddresses()->count())
        {
            /** @var ContactAddress $contactAddress */
            $contactAddress = $contact->getAddresses()->first();
            $address = new Address();
            $address->setLabel($contactAddress->getLabel());
            $address->setCountry($contactAddress->getCountry());
            $address->setRegion($contactAddress->getRegion());
            $address->setStreet($contactAddress->getStreet());
            $address->setPostalCode($contactAddress->getPostalCode());
            $address->setCity($contactAddress->getCity());
            $address->setPrimary(true);
            $customer->addAddress($address);
        }
    }
}

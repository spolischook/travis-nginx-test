#!/bin/bash
# This is daemonization shell wrapper for clank server #

# Includes #
source app/config/oro_env.conf;

unset CLANK_PID;
CLANK_PID="$(ps aux | grep clank:server | grep -v grep | awk {'print $2'})"

case "$1" in
    start)
        if [ -z "$CLANK_PID" ]; then
            echo -n "Oro Clank service starting..."
            cd $WEB_ROOT/$ORO_NAME/;
            setsid php app/console clank:server --env prod 0<&- &> $CLANK_LOG &
            sleep 1;
            CLANK_PID="$(ps aux | grep clank:server | grep -v grep | awk {'print $2'})"
            echo $CLANK_PID > /tmp/ws_$CLANK_PID.pid;
            echo "    OK"
        else
            echo "Oro Clank service is already running, aborting!"
            exit 1;
        fi
        ;;

    stop)
        if [ -n "$CLANK_PID" ]; then
            echo -n "Oro Clank service stopping..."
            kill -15 $CLANK_PID &>/dev/null;
            sleep 3;
            rm -f /tmp/ws_$CLANK_PID.pid;
            echo "    OK"
        else
            echo "Oro Clank server is not running, aborting!"
            exit 1;
        fi
        ;;

    status)
        if [ -n "$CLANK_PID" ]; then
            echo "Oro Clank server is running"
        elif [ -z "$CLANK_PID" ]; then
            echo "Oro Clank server is not running"
        else
            echo "Oro Clank status is invalid"
        fi
        ;;

    *)
        echo "Usage: $0 start|stop|status"
        exit 1
        ;;
esac

# EOF #

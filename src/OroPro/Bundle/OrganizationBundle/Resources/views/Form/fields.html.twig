{% block oro_type_choice_organization_type_widget %}
    {% spaceless %}
        <div class="horizontal">
            <div class="oro-clearfix">
                {{ form_widget(form.all) }}
                {{ form_label(form.all) }}
            </div>
        </div>
        <div class="controls-row organization-selective-selector">
            {{ form_widget(form.selective) }}
        </div>
        <script type="text/javascript">
            require(['jquery'], function($){
                $(function() {
                    var all_selector = 'input.all-selector:checkbox';
                    var selective_selectors = '.organization-selective-selector';

                    $(selective_selectors).hide();
                    if (!$(all_selector).prop('checked')) {
                        $(selective_selectors).show();
                    }
                    $(document).on('change', all_selector, function () {
                        if ($(this).prop('checked')) {
                            $(selective_selectors).hide();
                        } else {
                            $(selective_selectors).show();
                        }
                    });
                });
            });
        </script>
    {% endspaceless %}
{% endblock %}

{% block oro_organizations_select_widget %}
    {% spaceless %}
        {% set attr = attr|merge({'class': attr.class is defined ? attr.class ~ ' horizontal' : 'horizontal'}) %}
        {% set attr = attr|merge({'class': attr.class ~ ' validate-group'}) %}
        <div {{ block('widget_container_attributes') }}>
            {% if form.vars.show_organizations_selector is defined %}
                {% set globalOrgId = oropro_global_org_id() %}
                {% set options= {} %}
                <div class="accordion organization-structure{% if not accordion_enabled %} disabled{% endif %}"
                     data-page-component-module="oroorganization/js/app/components/organization-structure-tree-component"
                     data-page-component-options="{{ options|json_encode }}">
                    {% for org in form.vars.organization_tree_ids %}
                        <div class="accordion-group">
                            <div class="accordion-heding">
                                <div class="oro-clearfix">
                                    <a class="accordion-toggle collapsed" data-toggle="collapse" href="#organization_{{ org.id }}"></a>
                                    <label>
                                        <input type="checkbox"
                                               name="{{ form.vars.full_name }}[organizations][]" value="{{ org.id }}"
                                               {% if org.id in form.vars.selected_organizations %} checked="checked" {% endif %}
                                               class="org org-id-{{ org.id }}"/>
                                        <b>{{ org.name }}</b>
                                        {% if globalOrgId and globalOrgId == org.id %}
                                            ({{ 'oropro.organization.is_global_organization'|trans }})
                                        {% endif %}
                                    </label>
                                </div>
                            </div>
                            <div id="organization_{{ org.id }}" class="accordion-body collapse{% if not accordion_enabled %} in{% endif %}">
                                <div class="accordion-inner">
                                {% if org.children %}
                                    {{ _self.renderOrganizationChildren(form, org.id, org.children, form.vars.selected_business_units) }}
                                {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <input type="hidden" name="{{ form.vars.full_name }}[organizations][]" value="{{ form.default_organization.vars.value }}" />
                {{ _self.renderOrganizationChildren(
                    form,
                    form.vars.organization_tree_ids[0].organization,
                    form.vars.organization_tree_ids,
                    form.vars.selected_business_units,
                    0
                ) }}
            {% endif %}
        </div>
    {% endspaceless %}
{% endblock %}

{% macro renderOrganizationChildren(form, org_id, children = {}, selected = {}, level = 1) %}
    {% for child in children %}
        <div class="oro-clearfix">
            <span style="float:left;">
            {% for si in 0..(5 * level) %}{{ '&nbsp;' }}{% endfor %}
            </span>
            <label>
                <input type="checkbox"
                       name="{{ form.vars.full_name }}[businessUnits][]"
                       value="{{ child.id }}"
                        {% if child.id in selected %} checked="checked" {% endif %}
                       class="bu"
                       data-organization="{{ org_id }}"/>
                {{ child.name }}
            </label>
        </div>
        {% if child.children is defined %}
            {{ _self.renderOrganizationChildren(form, org_id, child.children, selected, sublevel + 1) }}
        {% endif %}
    {% endfor %}
{% endmacro %}

{% block oropro_organization_label_widget %}
    {% spaceless %}
        {% for choice in choices %}
            {% if choice.value == value|default('NONE') %}
                <div class="control-label">{{ choice.label }}</div>
            {% endif %}
        {% endfor %}
        <script type="text/javascript">
            require(['jquery', 'oroui/js/mediator'], function($, mediator) {
                $(function() {
                    var select2_fields = $('form#{{ form.parent.vars.id }} :input.select2');
                    $.each(select2_fields, function(index, el) {
                        $(el).data('select2_query_additional_params', {'_sa_org_id': {{ value }}});
                    });

                    function checkFormLinks () {
                        var form_links = $('form#{{ form.parent.vars.id }} a, form#{{ form.parent.vars.id }} :button');
                        $.each(form_links, function(index, el) {
                            if ($(el).data('purpose') == 'open-form-widget'
                                || $(el).data('purpose') == 'open-dialog-widget'
                            ) {
                                $(el).data('route_additional_params', {'_sa_org_id': {{ value }}});
                            }
                        });
                    }

                    checkFormLinks();
                    mediator.once('page:afterChange', checkFormLinks);
                });
            });
        </script>
    {% endspaceless %}
{% endblock %}

{% macro filterRoles(form) %}
    <script type="text/javascript">
        require(['jquery'], function ($) {
            "use strict";
            var roles = $('#{{ form.roles.vars.id }}').find('input[type="checkbox"]');
            var organizations = $('#{{ form.organizations.vars.id }}').find('input.org:checkbox');

            var permissionsMap = $.parseJSON('{{ form.vars.permissions_map | raw }}');

            roles.each(function(key, elm) {
                var roleId = elm.value;
                var granted = permissionsMap[roleId] == null || isOrganizationForRoleChecked(roleId);

                if (!granted) {
                    $('label[for="' + elm.id + '"]').hide();
                    $(elm).hide();
                }
            });

            $(function() {
                $(document).on('change', 'input.org:checkbox', function (e) {
                    if($(this).prop('checked') == false) {
                        roles.each(function (key, elm) {
                            var roleId = elm.value;
                            var granted = (permissionsMap[roleId] == null || isOrganizationForRoleChecked(roleId));
                            if (!granted) {
                                $(elm).prop('checked', false);
                            }
                        });
                    }
                    rebuildCheckboxes();
                });
            });

            function isOrganizationForRoleChecked(roleId) {
                var checkedOrganization = organizations.filter(function(key, elm) {
                    return (parseInt(elm.value) == permissionsMap[roleId] && elm.checked);
                });

                if (checkedOrganization.length == 0) {
                    return false;
                }
                return true;
            };

            function rebuildCheckboxes() {
                roles.each(function (key, elm) {
                    var roleId = elm.value;
                    var granted = (permissionsMap[roleId] == null || isOrganizationForRoleChecked(roleId));

                    if (!granted) {
                        $('label[for="' + elm.id + '"]').hide();
                        $(elm).hide();
                    } else {
                        $('label[for="' + elm.id + '"]').show();
                        $(elm).show();
                    }
                });
            }
        });
    </script>
{% endmacro %}

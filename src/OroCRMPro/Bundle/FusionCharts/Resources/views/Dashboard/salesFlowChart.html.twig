{% extends 'OroDashboardBundle:Dashboard:chartWidget.html.twig' %}

{% block content %}
    {% set data, nozzleData, hasData = {}, {}, false %}
    {% set isMobileVersion = isMobileVersion() %}
    {% for label, value in items %}
        {% if value %}
            {% set hasData = true %}
        {% endif %}
        {% if label in nozzleSteps %}
            {% if isMobileVersion %}
                {% set label = label ~ ': ' ~ value|oro_format_currency ~ '{br}(' ~ 'from'|trans ~ ' ' ~ quarterDate|oro_format_date ~ ')' %}
            {% else %}
                {% set label = label ~ ' (' ~ 'from'|trans ~ ' ' ~ quarterDate|oro_format_date ~ '): ' ~ value|oro_format_currency %}
            {% endif %}
            {% set nozzleData = nozzleData|merge([{label: label, toolText: label, value: 0, showValue: 0}]) %}
        {% else %}
            {% set label = label ~ ': ' ~ value|oro_format_currency %}
            {% set data = data|merge([{label: label, toolText: label, value: value}]) %}
        {% endif %}
    {% endfor %}

    {% if hasData %}
        <div class="chart-container">
            <div class="clearfix">
                <div id="{{ widgetId }}-chart" class="bar-chart chart"></div>
            </div>
        </div>

        {% set data = data|merge(nozzleData) %}
        {% set json = {
            'chart': {
                'labelDistance': isMobileVersion ? '15' : '',
                'showLabels': isMobileVersion ? '0' : '1',
                'showLegend': isMobileVersion ? '1' : '0',
                'legendNumColumns': '2',
                'useEllipsesWhenOverflow': '0',
                'isHollow': '0',
                'showValues': '0',
                'useSameSlantAngle': '0',
                'streamlinedData': '0',
                'isSliced': '1',
                'funnelYScale': '40',
                'enableSmartLabels': '1',
                'animation': '0',
                'bgAlpha': '0',
                'legendBorderAlpha': '0',
                'legendShadow': '0',
                'showBorder': '0',
                'paletteColors': 'c0dda6,7fab90,fdbc7c,fdbc7c,d6a970,72a4e1,ceebf3,5a897f'
            },
            'data': data
        } %}

        {% set height = isMobileVersion ? 300 + (data|length * 12) : 300 %}

        <script type="text/javascript">
            require(
                ['jquery', 'orocrmprofusioncharts/lib/FusionCharts.jqueryplugin'],
                function ($) {
                    $('#{{ widgetId }}-chart').insertFusionCharts({
                        type: 'Funnel',
                        dataSource: {{ json|json_encode|raw }},
                        dataFormat: 'json',
                        width: '100%',
                        height: '{{ height }}',
                        id: '{{ widgetId }}'
                    });
                }
            );
        </script>
    {% else %}
        <div class="clearfix no-data">
            <span>{{ 'oro.dashboard.no_data_found'|trans }}</span>
        </div>
    {% endif %}

{% endblock %}
